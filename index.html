<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام مراقبة مواقف السيارات - ANPR محسن</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script async src="https://docs.opencv.org/4.5.5/opencv.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: linear-gradient(to bottom, #f4f4f4, #e9ecef); }
        .container { max-width: 1200px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        header { background: linear-gradient(135deg, #0052cc, #007bff); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0; }
        header img { height: 60px; border-radius: 5px; }
        footer { background: #343a40; color: white; text-align: center; padding: 15px; margin-top: 20px; border-radius: 0 0 10px 10px; }
        video, canvas { border: 2px solid #007bff; margin: 10px 0; max-width: 100%; border-radius: 8px; }
        button { padding: 12px 24px; margin: 5px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
        select, input[type="text"], input[type="file"] { padding: 10px; margin: 5px; border-radius: 6px; border: 1px solid #007bff; width: 300px; }
        #result { font-size: 20px; font-weight: bold; margin: 15px 0; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; color: #155724; }
        .section { margin: 25px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 10px; border-radius: 6px; margin: 10px 0; display: none; }
        /* نافذة منبثقة */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .modal-content input { width: 100%; margin: 10px 0; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        .modal-content button { width: 48%; margin: 5px; }
        @media (max-width: 768px) { 
            .container { margin: 10px; padding: 15px; } 
            header { flex-direction: column; text-align: center; } 
            video, canvas, select, input[type="text"], input[type="file"] { width: 100%; height: auto; } 
            .modal-content { width: 90%; }
        }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: linear-gradient(135deg, #e9ecef, #f8f9fa); font-weight: bold; }
    </style>
</head>
<body>
    <header>
        <img src="https://via.placeholder.com/150x60.png?text=شعار+يمين" alt="شعار يمين">
        <h1>نظام مراقبة مواقف السيارات</h1>
        <img src="https://via.placeholder.com/150x60.png?text=شعار+يسار" alt="شعار يسار">
    </header>
    <div class="container">
        <!-- قسم الكاميرا والـ ANPR -->
        <section class="section">
            <h2>الكشف عن لوحة السيارة</h2>
            <label for="cameraSelect">اختر الكاميرا:</label>
            <select id="cameraSelect" onchange="changeCamera()">
                <option value="environment">الكاميرا الخلفية (موصى بها)</option>
                <option value="user">الكاميرا الأمامية</option>
            </select>
            <video id="video" width="640" height="480" autoplay></video>
            <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
            <br>
            <button onclick="startCamera()">بدء الكاميرا</button>
            <button onclick="scanPlate()">مسح اللوحة</button>
            <div id="result"></div>
            <div id="error" class="error"></div>
        </section>
        
        <!-- قسم البحث -->
        <section class="section">
            <h2>البحث في قاعدة البيانات</h2>
            <input type="text" id="searchInput" placeholder="ابحث برقم اللوحة أو المالك" onkeyup="searchDatabase()">
        </section>
        
        <!-- قسم قاعدة البيانات -->
        <section class="section">
            <h2>قاعدة بيانات السيارات المسموح بها</h2>
            <input type="file" id="fileInput" accept=".xlsx" onchange="loadExcel(event)">
            <button onclick="openAddCarModal()">إضافة سيارة</button>
            <button onclick="exportExcel()">تصدير Excel</button>
            <table id="allowedTable">
                <thead><tr><th>رقم اللوحة</th><th>المالك</th><th>نوع السيارة</th><th>مكان العمل</th><th>رقم الهاتف</th><th>ملاحظات</th><th>وقت الدخول</th><th>الإجراءات</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>
        
        <!-- قسم القائمة السوداء -->
        <section class="section">
            <h2>القائمة السوداء</h2>
            <input type="text" id="blacklistPlate" placeholder="أدخل رقم اللوحة للقائمة السوداء">
            <button onclick="addToBlacklist()">إضافة إلى القائمة السوداء</button>
            <table id="blacklistTable">
                <thead><tr><th>رقم اللوحة</th><th>ملاحظات</th><th>الإجراءات</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>
    </div>

    <!-- نافذة منبثقة لإضافة سيارة -->
    <div id="addCarModal" class="modal">
        <div class="modal-content">
            <h2>إضافة سيارة جديدة</h2>
            <input type="text" id="newPlate" placeholder="رقم اللوحة" required>
            <input type="text" id="newOwner" placeholder="المالك">
            <input type="text" id="newCarType" placeholder="نوع السيارة">
            <input type="text" id="newWorkplace" placeholder="مكان العمل">
            <input type="text" id="newPhone" placeholder="رقم الهاتف">
            <input type="text" id="newNotes" placeholder="ملاحظات">
            <button onclick="saveNewCar()">حفظ</button>
            <button onclick="closeAddCarModal()">إلغاء</button>
        </div>
    </div>

    <footer>
        <p>نظام مراقبة مواقف السيارات باستخدام ANPR | © 2025 | مدعوم بـ OpenCV.js و Tesseract.js</p>
    </footer>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let stream;
        let db = JSON.parse(localStorage.getItem('parkingDB')) || []; // قاعدة البيانات
        let blacklist = JSON.parse(localStorage.getItem('blacklist')) || []; // القائمة السوداء
        let isOpenCVLoaded = false;

        // تحميل OpenCV.js
        cv['onRuntimeInitialized'] = () => {
            isOpenCVLoaded = true;
            console.log('OpenCV.js جاهز');
        };

        // تغيير الكاميرا
        async function changeCamera() {
            const select = document.getElementById('cameraSelect');
            const currentFacingMode = select.value;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            await startCamera(currentFacingMode);
        }

        // بدء الكاميرا
        async function startCamera(facingMode = 'environment') {
            try {
                const constraints = {
                    video: {
                        facingMode: { ideal: facingMode },
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
            } catch (err) {
                const fallbackConstraints = { video: true };
                stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                document.getElementById('error').innerHTML = 'تم استخدام كاميرا افتراضية: ' + err.message;
                document.getElementById('error').style.display = 'block';
            }
        }

        // مسح اللوحة باستخدام OpenCV + Tesseract
        async function scanPlate() {
            if (!video.srcObject) {
                alert('ابدأ الكاميرا أولاً!');
                return;
            }
            if (!isOpenCVLoaded) {
                alert('OpenCV.js لم يُحمّل بعد، جرب لاحقًا!');
                return;
            }

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            let src = cv.imread(canvas);
            
            // معالجة محسنة لتحسين دقة OCR
            let gray = new cv.Mat();
            let blurred = new cv.Mat();
            let thresh = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
            cv.adaptiveThreshold(blurred, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 11, 2);
            cv.imshow(canvas, thresh);

            const imageData = canvas.toDataURL('image/png');
            src.delete(); gray.delete(); blurred.delete(); thresh.delete();

            try {
                const worker = await Tesseract.createWorker('eng', 1);
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ- '
                });
                const { data: { text } } = await worker.recognize(imageData);
                await worker.terminate();

                const plate = text.trim().replace(/\s+/g, '').toUpperCase();
                document.getElementById('result').innerHTML = `اللوحة المكتشفة: ${plate || 'لم يتم التعرف'}`;
                
                if (plate) {
                    checkParkingStatus(plate);
                }
            } catch (err) {
                document.getElementById('error').innerHTML = 'خطأ في التعرف: ' + err.message;
                document.getElementById('error').style.display = 'block';
            }
        }

        // التحقق من حالة الموقف
        function checkParkingStatus(plate) {
            const blacklistEntry = blacklist.find(row => row.Plate.toUpperCase() === plate);
            if (blacklistEntry) {
                document.getElementById('result').innerHTML += `<br>حالة الموقف: محظور (في القائمة السوداء) - ملاحظات: ${blacklistEntry.Notes || ''}`;
                return;
            }
            const entry = db.find(row => row.Plate.toUpperCase() === plate);
            if (entry && entry.Status === 'Allowed') {
                entry.EntryTime = new Date().toLocaleString();
                saveToLocalStorage();
                document.getElementById('result').innerHTML += `<br>حالة الموقف: مصرح - مالك: ${entry.Owner}`;
                displayAllowedTable();
            } else {
                document.getElementById('result').innerHTML += '<br>اللوحة غير مسجلة أو غير مصرح بها!';
            }
        }

        // تحميل Excel
        function loadExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                db = XLSX.utils.sheet_to_json(sheet);
                blacklist = db.filter(row => row.Status === 'Blocked');
                db = db.filter(row => row.Status !== 'Blocked');
                saveToLocalStorage();
                displayAllowedTable();
                displayBlacklistTable();
                alert('تم تحميل القاعدة بنجاح! عدد السجلات: ' + (db.length + blacklist.length));
            };
            reader.readAsArrayBuffer(file);
        }

        // حفظ إلى localStorage
        function saveToLocalStorage() {
            localStorage.setItem('parkingDB', JSON.stringify(db));
            localStorage.setItem('blacklist', JSON.stringify(blacklist));
        }

        // عرض جدول السيارات المسموح بها
        function displayAllowedTable(filter = null) {
            const tbody = document.querySelector('#allowedTable tbody');
            tbody.innerHTML = '';
            let filteredDb = filter ? db.filter(row => 
                row.Plate.toLowerCase().includes(filter) || 
                (row.Owner && row.Owner.toLowerCase().includes(filter))
            ) : db;
            filteredDb.forEach((row, index) => {
                const tr = tbody.insertRow();
                tr.insertCell(0).textContent = row.Plate || '';
                tr.insertCell(1).textContent = row.Owner || '';
                tr.insertCell(2).textContent = row.CarType || '';
                tr.insertCell(3).textContent = row.Workplace || '';
                tr.insertCell(4).textContent = row.Phone || '';
                tr.insertCell(5).textContent = row.Notes || '';
                tr.insertCell(6).textContent = row.EntryTime || '';
                const actionCell = tr.insertCell(7);
                actionCell.innerHTML = `
                    <button onclick="editRow(${index})">تعديل</button>
                    <button onclick="deleteRow(${index})">حذف</button>
                `;
            });
        }

        // عرض جدول القائمة السوداء
        function displayBlacklistTable() {
            const tbody = document.querySelector('#blacklistTable tbody');
            tbody.innerHTML = '';
            blacklist.forEach((row, index) => {
                const tr = tbody.insertRow();
                tr.insertCell(0).textContent = row.Plate || '';
                tr.insertCell(1).textContent = row.Notes || '';
                const actionCell = tr.insertCell(2);
                actionCell.innerHTML = `<button onclick="deleteFromBlacklist(${index})">حذف</button>`;
            });
        }

        // تعديل سجل
        function editRow(index) {
            const row = db[index];
            const newPlate = prompt('رقم اللوحة:', row.Plate);
            const newOwner = prompt('المالك:', row.Owner);
            const newCarType = prompt('نوع السيارة:', row.CarType);
            const newWorkplace = prompt('مكان العمل:', row.Workplace);
            const newPhone = prompt('رقم الهاتف:', row.Phone);
            const newNotes = prompt('ملاحظات:', row.Notes);
            if (newPlate) {
                db[index] = { 
                    Plate: newPlate, 
                    Owner: newOwner || '', 
                    CarType: newCarType || '', 
                    Workplace: newWorkplace || '', 
                    Phone: newPhone || '', 
                    Notes: newNotes || '', 
                    Status: row.Status, 
                    EntryTime: row.EntryTime || '' 
                };
                saveToLocalStorage();
                displayAllowedTable();
            }
        }

        // حذف سجل
        function deleteRow(index) {
            if (confirm('هل أنت متأكد من حذف هذا السجل؟')) {
                db.splice(index, 1);
                saveToLocalStorage();
                displayAllowedTable();
            }
        }

        // إضافة إلى القائمة السوداء
        function addToBlacklist() {
            const plate = document.getElementById('blacklistPlate').value.trim().toUpperCase();
            if (!plate) {
                alert('أدخل رقم لوحة!');
                return;
            }
            const notes = prompt('أدخل ملاحظات (اختياري):', '');
            blacklist.push({ Plate: plate, Notes: notes, Status: 'Blocked' });
            document.getElementById('blacklistPlate').value = '';
            saveToLocalStorage();
            displayBlacklistTable();
        }

        // حذف من القائمة السوداء
        function deleteFromBlacklist(index) {
            if (confirm('هل أنت متأكد من حذف هذه اللوحة من القائمة السوداء؟')) {
                blacklist.splice(index, 1);
                saveToLocalStorage();
                displayBlacklistTable();
            }
        }

        // محرك البحث
        function searchDatabase() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            displayAllowedTable(query);
        }

        // تصدير Excel
        function exportExcel() {
            const combinedDb = [...db, ...blacklist];
            const ws = XLSX.utils.json_to_sheet(combinedDb);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ParkingDB');
            XLSX.writeFile(wb, 'parking_updated.xlsx');
        }

        // إدارة النافذة المنبثقة
        function openAddCarModal() {
            document.getElementById('addCarModal').style.display = 'block';
            document.getElementById('newPlate').focus();
        }

        function closeAddCarModal() {
            document.getElementById('addCarModal').style.display = 'none';
            document.getElementById('newPlate').value = '';
            document.getElementById('newOwner').value = '';
            document.getElementById('newCarType').value = '';
            document.getElementById('newWorkplace').value = '';
            document.getElementById('newPhone').value = '';
            document.getElementById('newNotes').value = '';
        }

        function saveNewCar() {
            const plate = document.getElementById('newPlate').value.trim().toUpperCase();
            if (!plate) {
                alert('رقم اللوحة مطلوب!');
                return;
            }
            const newCar = {
                Plate: plate,
                Owner: document.getElementById('newOwner').value || '',
                CarType: document.getElementById('newCarType').value || '',
                Workplace: document.getElementById('newWorkplace').value || '',
                Phone: document.getElementById('newPhone').value || '',
                Notes: document.getElementById('newNotes').value || '',
                Status: 'Allowed',
                EntryTime: ''
            };
            db.push(newCar);
            saveToLocalStorage();
            displayAllowedTable();
            closeAddCarModal();
            alert('تم إضافة السيارة بنجاح!');
        }

        // تحميل البيانات من localStorage عند بدء الصفحة
        window.onload = function() {
            displayAllowedTable();
            displayBlacklistTable();
        };
    </script>
</body>
</html>
