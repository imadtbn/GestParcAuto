<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام مراقبة مواقف السيارات - ANPR مع YOLO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script async src="https://docs.opencv.org/4.5.5/opencv.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://raw.githubusercontent.com/Hyuto/yolov5-tfjs/main/dist/tf-yolov5.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background: linear-gradient(to bottom, #f4f4f4, #e9ecef); }
        .container { max-width: 1200px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        header { background: linear-gradient(135deg, #0052cc, #007bff); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0; }
        header img { height: 60px; border-radius: 5px; }
        footer { background: #343a40; color: white; text-align: center; padding: 15px; margin-top: 20px; border-radius: 0 0 10px 10px; }
        video, canvas { border: 2px solid #007bff; margin: 10px 0; max-width: 100%; border-radius: 8px; }
        button { padding: 12px 24px; margin: 5px; background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; border-radius: 6px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: linear-gradient(135deg, #e9ecef, #f8f9fa); font-weight: bold; }
        input[type="text"], input[type="file"] { padding: 10px; margin: 5px; border-radius: 6px; border: 1px solid #007bff; width: 300px; }
        #result { font-size: 20px; font-weight: bold; margin: 15px 0; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; color: #155724; }
        .section { margin: 25px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        .loading { text-align: center; color: #007bff; font-style: italic; }
        @media (max-width: 768px) { .container { margin: 10px; padding: 15px; } header { flex-direction: column; text-align: center; } video, canvas { width: 100%; height: auto; } input[type="text"] { width: 100%; } }
    </style>
</head>
<body>
    <header>
        <img src="https://via.placeholder.com/150x60.png?text=شعار+يمين" alt="شعار يمين">
        <h1>نظام مراقبة مواقف السيارات مع YOLO</h1>
        <img src="https://via.placeholder.com/150x60.png?text=شعار+يسار" alt="شعار يسار">
    </header>
    <div class="container">
        <!-- قسم الكاميرا والـ ANPR مع YOLO -->
        <section class="section">
            <h2>الكشف عن لوحة السيارة باستخدام YOLO</h2>
            <video id="video" width="640" height="480" autoplay></video>
            <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
            <canvas id="yoloCanvas" width="640" height="480" style="border: 2px solid #28a745; display:none;"></canvas>
            <br>
            <button onclick="startCamera()">بدء الكاميرا</button>
            <button onclick="scanPlateWithYOLO()">مسح اللوحة بـ YOLO</button>
            <div id="result"></div>
            <div id="loading" class="loading" style="display:none;">جاري تحميل نموذج YOLO...</div>
        </section>
        
        <!-- قسم البحث -->
        <section class="section">
            <h2>البحث في قاعدة البيانات</h2>
            <input type="text" id="searchInput" placeholder="ابحث برقم اللوحة أو المالك" onkeyup="searchDatabase()">
        </section>
        
        <!-- قسم قاعدة البيانات -->
        <section class="section">
            <h2>قاعدة بيانات السيارات المسموح بها</h2>
            <input type="file" id="fileInput" accept=".xlsx" onchange="loadExcel(event)">
            <button onclick="exportExcel()">تصدير Excel</button>
            <table id="allowedTable">
                <thead><tr><th>رقم اللوحة</th><th>المالك</th><th>نوع السيارة</th><th>مكان العمل</th><th>رقم الهاتف</th><th>ملاحظات</th><th>وقت الدخول</th><th>الإجراءات</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>
        
        <!-- قسم القائمة السوداء -->
        <section class="section">
            <h2>القائمة السوداء</h2>
            <input type="text" id="blacklistPlate" placeholder="أدخل رقم اللوحة للقائمة السوداء">
            <button onclick="addToBlacklist()">إضافة إلى القائمة السوداء</button>
            <table id="blacklistTable">
                <thead><tr><th>رقم اللوحة</th><th>ملاحظات</th><th>الإجراءات</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>
    </div>
    <footer>
        <p>نظام مراقبة مواقف السيارات باستخدام ANPR و YOLO | © 2025 | مدعوم بـ TensorFlow.js</p>
    </footer>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let yoloCanvas = document.getElementById('yoloCanvas');
        let ctx = canvas.getContext('2d');
        let yoloCtx = yoloCanvas.getContext('2d');
        let stream;
        let db = []; // قاعدة البيانات (Allowed + Blacklist)
        let blacklist = []; // القائمة السوداء
        let model; // نموذج YOLO
        let isYoloLoaded = false;

        // تحميل OpenCV.js
        cv['onRuntimeInitialized'] = () => {
            console.log('OpenCV.js جاهز');
        };

        // تحميل نموذج YOLOv5
        async function loadYoloModel() {
            if (isYoloLoaded) return model;
            document.getElementById('loading').style.display = 'block';
            try {
                model = await tf.loadGraphModel('https://raw.githubusercontent.com/Hyuto/yolov5-tfjs/main/models/yolov5n/model.json', { fromTFHub: false });
                isYoloLoaded = true;
                document.getElementById('loading').style.display = 'none';
                console.log('نموذج YOLO جاهز');
            } catch (err) {
                alert('خطأ في تحميل YOLO: ' + err.message);
            }
        }

        // بدء الكاميرا
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                await loadYoloModel(); // تحميل YOLO عند بدء الكاميرا
            } catch (err) {
                alert('خطأ في الوصول إلى الكاميرا: ' + err.message);
            }
        }

        // مسح اللوحة باستخدام YOLO + OpenCV + Tesseract
        async function scanPlateWithYOLO() {
            if (!video.srcObject || !model) {
                alert('ابدأ الكاميرا وانتظر تحميل YOLO!');
                return;
            }
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            yoloCtx.drawImage(video, 0, 0, yoloCanvas.width, yoloCanvas.height);
            let src = cv.imread(canvas);

            // YOLO كشف السيارة وتقدير منطقة اللوحة
            const inputTensor = tf.browser.fromPixels(yoloCanvas).expandDims(0).div(255.0).expandDims(-1).squeeze(-1);
            const predictions = await model.executeAsync(inputTensor);
            const [boxes, scores, classes] = await Promise.all(predictions.map(p => p.array()));
            inputTensor.dispose();
            predictions.forEach(p => p.dispose());

            let plateRegion = null;
            for (let i = 0; i < scores[0].length; i++) {
                if (scores[0][i] > 0.5 && (classes[0][i] === 2 || classes[0][i] === 7)) { // car=2, truck=7 في COCO
                    const box = boxes[0][i];
                    const x = box[0] * canvas.width;
                    const y = box[1] * canvas.height;
                    const w = (box[2] - box[0]) * canvas.width;
                    const h = (box[3] - box[1]) * canvas.height;
                    // افتراض اللوحة في أسفل السيارة (يمكن تحسينه)
                    const plateY = y + h * 0.8;
                    const plateH = h * 0.15;
                    plateRegion = new cv.Rect(x, plateY, w, plateH);
                    // رسم bounding box
                    yoloCtx.strokeStyle = 'red';
                    yoloCtx.lineWidth = 2;
                    yoloCtx.strokeRect(x, plateY, w, plateH);
                    yoloCanvas.style.display = 'block';
                    break;
                }
            }

            if (!plateRegion) {
                document.getElementById('result').innerHTML = 'لم يتم كشف سيارة أو لوحة!';
                src.delete();
                return;
            }

            // قص اللوحة ومعالجتها بـ OpenCV
            let plateImg = src.roi(plateRegion);
            let gray = new cv.Mat();
            let blurred = new cv.Mat();
            let edges = new cv.Mat();
            cv.cvtColor(plateImg, gray, cv.COLOR_RGBA2GRAY);
            cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
            cv.Canny(blurred, edges, 50, 150);
            cv.imshow(canvas, edges);

            const imageData = canvas.toDataURL('image/png');
            src.delete(); plateImg.delete(); gray.delete(); blurred.delete(); edges.delete();

            // Tesseract لقراءة النص
            try {
                const worker = await Tesseract.createWorker('eng', 1);
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ- '
                });
                const { data: { text } } = await worker.recognize(imageData);
                await worker.terminate();

                const plate = text.trim().replace(/\s+/g, '').toUpperCase();
                document.getElementById('result').innerHTML = `اللوحة المكتشفة بـ YOLO: ${plate || 'لم يتم التعرف'}`;
                
                if (plate) {
                    checkParkingStatus(plate);
                }
            } catch (err) {
                alert('خطأ في التعرف: ' + err.message);
            }
        }

        // التحقق من حالة الموقف (كما سابقًا)
        function checkParkingStatus(plate) {
            const blacklistEntry = blacklist.find(row => row.Plate.toUpperCase() === plate);
            if (blacklistEntry) {
                document.getElementById('result').innerHTML += `<br>حالة الموقف: محظور (في القائمة السوداء) - ملاحظات: ${blacklistEntry.Notes || ''}`;
                return;
            }
            const entry = db.find(row => row.Plate.toUpperCase() === plate);
            if (entry && entry.Status === 'Allowed') {
                entry.EntryTime = new Date().toLocaleString();
                document.getElementById('result').innerHTML += `<br>حالة الموقف: مصرح - مالك: ${entry.Owner}`;
                displayAllowedTable();
            } else {
                document.getElementById('result').innerHTML += '<br>اللوحة غير مسجلة أو غير مصرح بها!';
            }
        }

        // باقي الدوال كما هي (loadExcel, displayAllowedTable, إلخ)
        function loadExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                db = XLSX.utils.sheet_to_json(sheet);
                blacklist = db.filter(row => row.Status === 'Blocked');
                db = db.filter(row => row.Status !== 'Blocked');
                displayAllowedTable();
                displayBlacklistTable();
                alert('تم تحميل القاعدة بنجاح! عدد السجلات: ' + (db.length + blacklist.length));
            };
            reader.readAsArrayBuffer(file);
        }

        function displayAllowedTable(filter = null) {
            const tbody = document.querySelector('#allowedTable tbody');
            tbody.innerHTML = '';
            let filteredDb = filter ? db.filter(row => 
                row.Plate.toLowerCase().includes(filter) || 
                (row.Owner && row.Owner.toLowerCase().includes(filter))
            ) : db;
            filteredDb.forEach((row, index) => {
                const tr = tbody.insertRow();
                tr.insertCell(0).textContent = row.Plate || '';
                tr.insertCell(1).textContent = row.Owner || '';
                tr.insertCell(2).textContent = row.CarType || '';
                tr.insertCell(3).textContent = row.Workplace || '';
                tr.insertCell(4).textContent = row.Phone || '';
                tr.insertCell(5).textContent = row.Notes || '';
                tr.insertCell(6).textContent = row.EntryTime || '';
                const actionCell = tr.insertCell(7);
                actionCell.innerHTML = `
                    <button onclick="editRow(${index})">تعديل</button>
                    <button onclick="deleteRow(${index})">حذف</button>
                `;
            });
        }

        function displayBlacklistTable() {
            const tbody = document.querySelector('#blacklistTable tbody');
            tbody.innerHTML = '';
            blacklist.forEach((row, index) => {
                const tr = tbody.insertRow();
                tr.insertCell(0).textContent = row.Plate || '';
                tr.insertCell(1).textContent = row.Notes || '';
                const actionCell = tr.insertCell(2);
                actionCell.innerHTML = `<button onclick="deleteFromBlacklist(${index})">حذف</button>`;
            });
        }

        function editRow(index) {
            const row = db[index];
            const newPlate = prompt('رقم اللوحة:', row.Plate);
            const newOwner = prompt('المالك:', row.Owner);
            const newCarType = prompt('نوع السيارة:', row.CarType);
            const newWorkplace = prompt('مكان العمل:', row.Workplace);
            const newPhone = prompt('رقم الهاتف:', row.Phone);
            const newNotes = prompt('ملاحظات:', row.Notes);
            if (newPlate) db[index] = { 
                Plate: newPlate, 
                Owner: newOwner || '', 
                CarType: newCarType || '', 
                Workplace: newWorkplace || '', 
                Phone: newPhone || '', 
                Notes: newNotes || '', 
                Status: row.Status, 
                EntryTime: row.EntryTime || '' 
            };
            displayAllowedTable();
        }

        function deleteRow(index) {
            if (confirm('هل أنت متأكد من حذف هذا السجل؟')) {
                db.splice(index, 1);
                displayAllowedTable();
            }
        }

        function addToBlacklist() {
            const plate = document.getElementById('blacklistPlate').value.trim().toUpperCase();
            if (!plate) {
                alert('أدخل رقم لوحة!');
                return;
            }
            const notes = prompt('أدخل ملاحظات (اختياري):', '');
            blacklist.push({ Plate: plate, Notes: notes, Status: 'Blocked' });
            document.getElementById('blacklistPlate').value = '';
            displayBlacklistTable();
        }

        function deleteFromBlacklist(index) {
            if (confirm('هل أنت متأكد من حذف هذه اللوحة من القائمة السوداء؟')) {
                blacklist.splice(index, 1);
                displayBlacklistTable();
            }
        }

        function searchDatabase() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            displayAllowedTable(query);
        }

        function exportExcel() {
            const combinedDb = [...db, ...blacklist];
            const ws = XLSX.utils.json_to_sheet(combinedDb);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ParkingDB');
            XLSX.writeFile(wb, 'parking_updated.xlsx');
        }
    </script>
</body>
</html>
