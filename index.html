
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>نظام تتبع وادارة حضيرة السيارات — مع OpenCV و OCR</title>

<!-- مكتبات -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.3.2/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.7.0/opencv.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{--p:#1f2937;--s:#2563eb;--a:#ef4444;--bg:#f7fafc}
*{box-sizing:border-box;font-family:Inter,Segoe UI,Tahoma,Arial}
body{margin:0;background:linear-gradient(180deg,#eef2ff,#ffffff);color:#111;min-height:100vh;padding:18px}
.container{max-width:1200px;margin:0 auto}
.header{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,var(--p),#111827);color:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,.08)}
.header h1{margin:0;font-size:18px}
.grid{display:grid;grid-template-columns:360px 1fr;gap:18px;margin-top:18px}
.card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,.04)}
.controls button{width:100%;margin-bottom:8px;padding:10px;border-radius:8px;border:none;background:var(--s);color:#fff;cursor:pointer}
.controls .outline{background:transparent;color:var(--s);border:1px solid var(--s)}
.table-wrap{overflow:auto;max-height:560px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2ff;text-align:right}
th{background:#0f172a;color:#fff;position:sticky;top:0;cursor:pointer}
.note{max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.stat-row{display:flex;gap:8px;margin-top:12px}
.stat{flex:1;background:#f8fafc;padding:12px;border-radius:8px;text-align:center}
.modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,.5);align-items:center;justify-content:center;z-index:40}
.modal .dialog{width:94%;max-width:820px;background:#fff;padding:16px;border-radius:10px}
.controls .small{display:flex;gap:8px}
.hidden{display:none}
.badge{display:inline-block;padding:4px 8px;border-radius:6px;background:#fde68a;color:#92400e;font-weight:600}
.blacklist{color:#fff;background:var(--a);padding:6px 8px;border-radius:6px}
.preview-plate{font-weight:800;font-size:20px;letter-spacing:2px;background:#0f172a;color:#fff;padding:8px;border-radius:6px;display:inline-block}
.icon-btn{background:transparent;border:1px solid #e6eefc;padding:8px;border-radius:8px;cursor:pointer}
.camera-area{background:#000;border-radius:8px;height:280px;display:flex;align-items:center;justify-content:center;overflow:hidden}
input,select,textarea{padding:8px;border:1px solid #e6eefc;border-radius:6px;width:100%}
.small-input{padding:6px}
.footer-note{font-size:13px;color:#374151;margin-top:8px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>نظام تتبع وادارة حضيرة السيارات — OpenCV + OCR</h1>
    <div style="display:flex;gap:12px;align-items:center">
      <span class="badge" id="totalCars">0</span>
      <button class="icon-btn" id="exportBtn"><i class="fas fa-file-export"></i> تصدير</button>
      <button class="icon-btn" id="importBtn"><i class="fas fa-file-import"></i> استيراد</button>
    </div>
  </div>

  <div class="grid">
    <!-- لوحة التحكم -->
    <div class="card controls">
      <h3>أدوات</h3>
      <div style="margin:8px 0">
        <input id="searchInput" placeholder="ابحث برقم التسجيل أو السائق..." />
      </div>
      <div class="small" style="margin-bottom:8px">
        <button onclick="searchData()" class="outline">بحث</button>
        <button onclick="clearSearch()">مسح</button>
      </div>

      <button onclick="openAddModal()">إضافة سيارة</button>
      <button onclick="openScannerModal()">مسح لوحة (كاميرا)</button>
      <button onclick="document.getElementById('fileIn').click()">استيراد Excel</button>
      <input id="fileIn" type="file" accept=".xlsx,.xls" class="hidden" />
      <button onclick="exportToExcel()">تصدير Excel</button>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef2ff"/>

      <h4>قائمة سوداء</h4>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="blackPlate" placeholder="أدخل رقم اللوحة لإضافته" />
        <button onclick="addToBlacklist()">أضف</button>
      </div>
      <div id="blacklistContainer"></div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef2ff"/>

      <h4>إحصائيات سريعة</h4>
      <div class="stat-row">
        <div class="stat"><div id="statTotal">0</div><div>إجمالي</div></div>
        <div class="stat"><div id="statWithNotes">0</div><div>مع ملاحظات</div></div>
        <div class="stat"><div id="statBlack">0</div><div>محظورة</div></div>
      </div>

      <div class="footer-note">ملاحظة: يستخدم OpenCV لمعالجة الصورة قبل إرسالها إلى Tesseract لتحسين الدقة.</div>
    </div>

    <!-- لوحة البيانات -->
    <div class="card">
      <h3>قاعدة بيانات السيارات</h3>
      <div class="table-wrap">
        <table id="carsTable">
          <thead>
            <tr>
              <th data-col="driverName" onclick="sortTable('driverName')">السائق</th>
              <th data-col="position" onclick="sortTable('position')">الوحدة</th>
              <th data-col="brand" onclick="sortTable('brand')">العلامة</th>
              <th data-col="carName" onclick="sortTable('carName')">النوع</th>
              <th data-col="registrationNumber" onclick="sortTable('registrationNumber')">رقم التسجيل</th>
              <th data-col="phoneNumber" onclick="sortTable('phoneNumber')">الهاتف</th>
              <th>ملاحظة</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div class="modal" id="addModal">
  <div class="dialog">
    <h3 id="addTitle">إضافة / تعديل سيارة</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <input id="m_driverName" placeholder="اسم السائق" />
      <input id="m_position" placeholder="الوحدة/المصلحة" />
      <input id="m_brand" placeholder="العلامة" />
      <input id="m_carName" placeholder="نوع المركبة" />
      <input id="m_registrationNumber" placeholder="رقم التسجيل" />
      <input id="m_phoneNumber" placeholder="هاتف" />
      <textarea id="m_note" placeholder="ملاحظة" style="grid-column:1/3"></textarea>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button onclick="saveModal()">حفظ</button>
      <button onclick="closeModal('addModal')">إلغاء</button>
    </div>
  </div>
</div>

<div class="modal" id="scannerModal">
  <div class="dialog">
    <h3>مسح لوحة الترقيم</h3>
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1">
        <div class="camera-area" id="cameraArea">
          <video id="video" playsinline autoplay class="hidden" style="width:100%;height:100%;object-fit:cover"></video>
          <canvas id="canvasPreview" class="hidden"></canvas>
          <div id="cameraPlaceholder" style="color:#fff">الكاميرا غير مفعلة</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button onclick="enableCamera()">تفعيل الكاميرا</button>
          <button onclick="captureFrame()">التقاط</button>
          <button onclick="stopCamera()">إيقاف</button>
        </div>
        <div style="margin-top:8px">
          <input id="uploadImg" type="file" accept="image/*" />
        </div>
      </div>

      <div style="width:320px">
        <div>لوحة المعاينة</div>
        <div style="margin:8px 0"><span class="preview-plate" id="platePreview">--- ---</span></div>
        <div id="matchResult"></div>
        <div style="margin-top:8px">
          <button onclick="runOcrOnCurrent()">تحليل الصورة (OpenCV → OCR)</button>
          <button onclick="closeModal('scannerModal')">إغلاق</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- عناصر خفية -->
<input type="file" id="hiddenImgInput" accept="image/*" class="hidden" />

<script>
/* ===== بيانات وبرامج مساعدة ===== */
let carsData = [];
let blacklist = [];
const LS_KEY = 'fleet_v3';
const LS_BLACK = 'fleet_black_v1';
let editIndex = -1;
let sortCol = null, sortDir = 'asc';
let videoStream = null;
let opencvReady = false;
let tesseractWorker = null;

/* انتظار تحميل OpenCV */
function onOpenCvReady() {
  opencvReady = true;
  console.log('OpenCV ready');
}
if (typeof cv !== 'undefined') {
  if (cv['onRuntimeInitialized']) cv['onRuntimeInitialized']=onOpenCvReady;
  else onOpenCvReady();
}

/* تحميل Tesseract worker مرة واحدة */
(async function initTesseract(){
  tesseractWorker = Tesseract.createWorker({
    logger: m => { /* يمكن ربط بشريط تقدم */ }
  });
  await tesseractWorker.load();
  await tesseractWorker.loadLanguage('ara+eng');
  await tesseractWorker.initialize('ara+eng');
})();

/* ===== تحميل من LocalStorage ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const s = localStorage.getItem(LS_KEY);
  const b = localStorage.getItem(LS_BLACK);
  if (s) carsData = JSON.parse(s);
  if (b) blacklist = JSON.parse(b);
  renderTable();
  renderBlacklist();
  updateStats();
});

/* ===== عمليات CRUD بسيطة ===== */
function openAddModal(idx=-1){
  editIndex = idx;
  document.getElementById('addModal').style.display = 'flex';
  if (idx===-1){
    document.getElementById('addTitle').textContent = 'إضافة سيارة جديدة';
    ['m_driverName','m_position','m_brand','m_carName','m_registrationNumber','m_phoneNumber','m_note'].forEach(id=>document.getElementById(id).value='');
  } else {
    const c = carsData[idx];
    document.getElementById('addTitle').textContent = 'تعديل بيانات السيارة';
    document.getElementById('m_driverName').value = c.driverName || '';
    document.getElementById('m_position').value = c.position || '';
    document.getElementById('m_brand').value = c.brand || '';
    document.getElementById('m_carName').value = c.carName || '';
    document.getElementById('m_registrationNumber').value = c.registrationNumber || '';
    document.getElementById('m_phoneNumber').value = c.phoneNumber || '';
    document.getElementById('m_note').value = c.note || '';
  }
}
function closeModal(id){document.getElementById(id).style.display='none';}
function saveModal(){
  const obj = {
    driverName: document.getElementById('m_driverName').value.trim(),
    position: document.getElementById('m_position').value.trim(),
    brand: document.getElementById('m_brand').value.trim(),
    carName: document.getElementById('m_carName').value.trim(),
    registrationNumber: document.getElementById('m_registrationNumber').value.trim(),
    phoneNumber: document.getElementById('m_phoneNumber').value.trim(),
    note: document.getElementById('m_note').value.trim()
  };
  if (!obj.registrationNumber) { alert('أدخل رقم التسجيل'); return; }
  if (editIndex===-1) carsData.push(obj); else carsData[editIndex]=obj;
  persist();
  closeModal('addModal');
  renderTable();
  updateStats();
}

/* ===== حفظ واسترجاع ===== */
function persist(){
  localStorage.setItem(LS_KEY, JSON.stringify(carsData));
  localStorage.setItem(LS_BLACK, JSON.stringify(blacklist));
}

/* ===== عرض الجدول ===== */
function renderTable(filterList = null){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  const data = filterList || carsData;
  if (!data.length){ tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:20px">لا توجد بيانات</td></tr>'; return;}
  data.forEach((c, i)=>{
    const tr = document.createElement('tr');
    const isBlack = blacklist.includes((c.registrationNumber||'').replace(/\s+/g,'').toLowerCase());
    tr.innerHTML = `
      <td>${esc(c.driverName)}</td>
      <td>${esc(c.position)}</td>
      <td>${esc(c.brand)}</td>
      <td>${esc(c.carName)}</td>
      <td>${esc(c.registrationNumber)} ${isBlack?'<span class="blacklist">محظورة</span>':''}</td>
      <td>${esc(c.phoneNumber)}</td>
      <td class="note">${esc(c.note)}</td>
      <td style="white-space:nowrap">
        <button onclick="openAddModal(${i})">تعديل</button>
        <button onclick="deleteRow(${i})" style="margin-left:6px;background:#ef4444;color:#fff;">حذف</button>
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('totalCars').textContent = carsData.length;
}
function esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function deleteRow(i){ if(!confirm('تأكيد الحذف؟')) return; carsData.splice(i,1); persist(); renderTable(); updateStats(); }

/* ===== فرز وبحث ===== */
function sortTable(col){
  if (sortCol===col) sortDir = (sortDir==='asc'?'desc':'asc'); else { sortCol=col; sortDir='asc'; }
  carsData.sort((a,b)=>{
    const A = (a[col]||'').toString().toLowerCase();
    const B = (b[col]||'').toString().toLowerCase();
    if (A<B) return sortDir==='asc'?-1:1;
    if (A>B) return sortDir==='asc'?1:-1;
    return 0;
  });
  renderTable();
}
function searchData(){
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  if (!q) return renderTable();
  const filtered = carsData.filter(c => Object.values(c).some(v => (v||'').toString().toLowerCase().includes(q)));
  renderTable(filtered);
}
function clearSearch(){ document.getElementById('searchInput').value=''; renderTable(); }

/* ===== إحصائيات وقائمة سوداء ===== */
function addToBlacklist(){
  const p = document.getElementById('blackPlate').value.trim();
  if (!p) return;
  const key = p.replace(/\s+/g,'').toLowerCase();
  if (!blacklist.includes(key)) blacklist.push(key);
  document.getElementById('blackPlate').value='';
  renderBlacklist(); persist(); updateStats();
}
function removeFromBlacklist(i){ blacklist.splice(i,1); renderBlacklist(); persist(); updateStats(); }
function renderBlacklist(){
  const c = document.getElementById('blacklistContainer'); c.innerHTML='';
  if (!blacklist.length){ c.innerHTML='<div>لا توجد لوحات محظورة</div>'; return; }
  blacklist.forEach((b,i)=> {
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='6px';
    div.innerHTML = `<div class="blacklist">${b.toUpperCase()}</div><button onclick="removeFromBlacklist(${i})">إزالة</button>`;
    c.appendChild(div);
  });
}
function updateStats(){
  document.getElementById('statTotal').textContent = carsData.length;
  document.getElementById('statWithNotes').textContent = carsData.filter(c=>c.note && c.note.trim()!=='').length;
  document.getElementById('statBlack').textContent = carsData.filter(c => blacklist.includes((c.registrationNumber||'').replace(/\s+/g,'').toLowerCase())).length;
}

/* ===== استيراد / تصدير Excel ===== */
document.getElementById('fileIn').addEventListener('change', loadExcelFile);
function loadExcelFile(e){
  const fi = e.target.files[0]; if(!fi) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    const wb = XLSX.read(ev.target.result, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws);
    json.forEach(row=>{
      carsData.push({
        driverName: row['إسم مستخدم المركبة']||row['driverName']||'',
        position: row['الوحدة/المصلحة']||row['position']||'',
        brand: row['العلامة التجارية']||row['brand']||'',
        carName: row['نوع المركبة']||row['carName']||'',
        registrationNumber: row['رقم تسجيل المركبة']||row['registrationNumber']||'',
        phoneNumber: row['هاتف المستخدم']||row['phoneNumber']||'',
        note: row['الملاحظة']||row['note']||''
      });
    });
    persist(); renderTable(); updateStats();
  };
  reader.readAsArrayBuffer(fi);
  e.target.value='';
}
function exportToExcel(){
  if (!carsData.length){ alert('لا توجد بيانات للتصدير'); return; }
  const out = carsData.map(c=>({
    'إسم مستخدم المركبة': c.driverName,
    'الوحدة/المصلحة': c.position,
    'العلامة التجارية': c.brand,
    'نوع المركبة': c.carName,
    'رقم تسجيل المركبة': c.registrationNumber,
    'هاتف المستخدم': c.phoneNumber,
    'الملاحظة': c.note
  }));
  const ws = XLSX.utils.json_to_sheet(out);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'بيانات');
  XLSX.writeFile(wb, 'بيانات_السيارات.xlsx');
}

/* ===== كاميرا / تحميل صورة ===== */
document.getElementById('uploadImg').addEventListener('change', async (e)=> {
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  await loadImageToCanvas(url);
});
async function enableCamera(){
  try {
    const v = document.getElementById('video');
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280}}});
    videoStream = stream;
    v.srcObject = stream; v.classList.remove('hidden');
    document.getElementById('cameraPlaceholder').classList.add('hidden');
    await v.play();
  } catch (err) { alert('تعذر الوصول إلى الكاميرا'); console.error(err); }
}
function stopCamera(){ if (videoStream) videoStream.getTracks().forEach(t=>t.stop()); const v=document.getElementById('video'); v.pause(); v.classList.add('hidden'); document.getElementById('cameraPlaceholder').classList.remove('hidden'); }
function captureFrame(){
  const v = document.getElementById('video');
  if (v.classList.contains('hidden')) { alert('الكاميرا غير مفعلة'); return; }
  const c = document.getElementById('canvasPreview');
  c.width = v.videoWidth; c.height = v.videoHeight;
  const ctx = c.getContext('2d'); ctx.drawImage(v,0,0,c.width,c.height);
  c.classList.remove('hidden');
  runOcrOnCanvas(c);
}
async function loadImageToCanvas(src){
  const img = new Image(); img.src = src;
  await img.decode();
  const c = document.getElementById('canvasPreview');
  c.width = img.naturalWidth; c.height = img.naturalHeight;
  c.getContext('2d').drawImage(img,0,0,c.width,c.height);
  c.classList.remove('hidden');
  runOcrOnCanvas(c);
}

/* ===== OpenCV معالجة الصورة =====
   خطوات:
   1) تحويل رمادي
   2) معاملة نسبة وتوسيع
   3) كشف الحواف + إغلاق مرفقي لايجاد اللوحة المحتملة
   4) قص أكبر مستطيل محتمل ثم تحسين التباين والعتبة
*/
function preprocessWithOpenCV(canvas){
  return new Promise((resolve, reject)=>{
    if (!opencvReady){ resolve(canvas.toDataURL()); return; } // fallback
    try {
      const src = cv.imread(canvas);
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      // إلغاء الضجيج
      let blur = new cv.Mat();
      cv.bilateralFilter(gray, blur, 9, 75, 75);
      // تحسين التباين
      let clahe = new cv.Mat();
      let clipLimit = 2.0; let tileGridSize = new cv.Size(8,8);
      let claheObj = new cv.CLAHE(clipLimit, tileGridSize);
      claheObj.apply(blur, clahe);
      // كشف حواف
      let edges = new cv.Mat();
      cv.Canny(clahe, edges, 50, 150);
      // تهيئة المورفولوجي لتوصيل الحواف
      let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(17,3));
      cv.morphologyEx(edges, edges, cv.MORPH_CLOSE, kernel);
      // إيجاد contours
      let contours = new cv.MatVector();
      let hierarchy = new cv.Mat();
      cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
      // البحث عن أكبر مستطيل مناسب
      let maxRect = null; let maxArea = 0;
      for (let i=0;i<contours.size();i++){
        const cnt = contours.get(i);
        const peri = cv.arcLength(cnt, true);
        const approx = new cv.Mat();
        cv.approxPolyDP(cnt, approx, 0.02 * peri, true);
        if (approx.rows >= 4) {
          const rect = cv.boundingRect(approx);
          const area = rect.width * rect.height;
          // معيار نسبة اللوحة: عرض أكبر من الارتفاع
          const ratio = rect.width / rect.height;
          if (area > maxArea && ratio > 2 && ratio < 8 && rect.width > 60) {
            maxArea = area; maxRect = rect;
          }
        }
        cnt.delete();
      }
      let resultCanvas = document.createElement('canvas');
      if (maxRect){
        resultCanvas.width = maxRect.width; resultCanvas.height = maxRect.height;
        const roi = src.roi(maxRect);
        // تحسين نهائي: تحويل لثنائي مع CLAHE ثم إرجاع للكانفاس
        let roiGray = new cv.Mat();
        cv.cvtColor(roi, roiGray, cv.COLOR_RGBA2GRAY);
        let roiClahe = new cv.Mat();
        claheObj.apply(roiGray, roiClahe);
        cv.threshold(roiClahe, roiClahe, 0, 255, cv.THRESH_BINARY + cv.THRESH_OTSU);
        cv.imshow(resultCanvas, roiClahe);
        roi.delete(); roiGray.delete(); roiClahe.delete();
      } else {
        // لا يوجد ROI واضح، فنعيد الصورة المعالجة بالـCLAHE كاملة
        resultCanvas.width = src.cols; resultCanvas.height = src.rows;
        cv.imshow(resultCanvas, clahe);
      }
      // تنظيف
      src.delete(); gray.delete(); blur.delete(); clahe.delete(); edges.delete(); contours.delete(); hierarchy.delete(); claheObj.delete();
      resolve(resultCanvas.toDataURL());
    } catch (err) {
      console.error('OpenCV error', err);
      resolve(canvas.toDataURL());
    }
  });
}

/* ===== تشغيل OCR على كانفاس (بمعالجة OpenCV أولاً) ===== */
async function runOcrOnCanvas(canvas){
  try {
    const processedDataUrl = await preprocessWithOpenCV(canvas);
    // عرض معاينة وتهيئة للعناصر
    const img = new Image(); img.src = processedDataUrl; await img.decode();
    const tmp = document.createElement('canvas'); tmp.width = img.naturalWidth; tmp.height = img.naturalHeight;
    tmp.getContext('2d').drawImage(img,0,0);
    document.getElementById('platePreview').textContent = 'جارٍ التحليل...';
    // إرسال للـTesseract
    const { data: { text } } = await tesseractWorker.recognize(tmp);
    const plate = normalizePlateText(text);
    document.getElementById('platePreview').textContent = plate || 'لم يتم التعرف';
    checkMatch(plate);
  } catch (err) {
    console.error(err); alert('حدث خطأ أثناء الـ OCR');
  }
}

/* واجهة لتشغيل OCR على الصورة الحالية */
async function runOcrOnCurrent(){
  const c = document.getElementById('canvasPreview');
  if (c.classList.contains('hidden')) { alert('لا توجد صورة'); return; }
  await runOcrOnCanvas(c);
}

/* تنظيف نص اللوحة */
function normalizePlateText(text){
  if (!text) return '';
  let cleaned = text.replace(/[^0-9A-Za-z\u0600-\u06FF\-]/g,'').trim();
  cleaned = cleaned.replace(/\s+/g,'');
  return cleaned.toUpperCase();
}

/* مقارنة بالبيانات و القائمة السوداء */
function checkMatch(plate){
  const key = (plate||'').replace(/\s+/g,'').toLowerCase();
  const found = carsData.find(c => (c.registrationNumber||'').replace(/\s+/g,'').toLowerCase() === key);
  const matchDiv = document.getElementById('matchResult');
  if (blacklist.includes(key)){
    matchDiv.innerHTML = `<div style="background:#fee2e2;padding:8px;border-radius:6px;color:#991b1b">هذه اللوحة مُدرجة في القائمة السوداء</div>`;
    return;
  }
  if (found){
    matchDiv.innerHTML = `<div style="background:#ecfeff;padding:8px;border-radius:6px;color:#064e3b">
      <strong>موجودة:</strong> ${esc(found.driverName)} — ${esc(found.position)} — ${esc(found.brand)} — ${esc(found.carName)}
    </div>`;
  } else {
    matchDiv.innerHTML = `<div style="background:#fff7ed;padding:8px;border-radius:6px;color:#92400e">اللوحة غير موجودة في السجلات</div>`;
  }
}

/* ===== أدوات مساعدة أخيرة ===== */
function deleteAll(){ if(!confirm('مسح جميع البيانات؟')) return; carsData=[]; persist(); renderTable(); updateStats(); }
document.getElementById('exportBtn').addEventListener('click', exportToExcel);
document.getElementById('importBtn').addEventListener('click', ()=>document.getElementById('fileIn').click());

/* تنظيف الخروج */
window.addEventListener('beforeunload', ()=> {
  if (videoStream) videoStream.getTracks().forEach(t=>t.stop());
  if (tesseractWorker) tesseractWorker.terminate();
});
</script>
</body>
</html>