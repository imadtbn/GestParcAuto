<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>نظام تتبع حضيرة السيارات — Auto OpenCV + OCR</title>

<!-- مكتبات -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.3.2/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.7.0/opencv.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{--p:#0f172a;--s:#2563eb;--a:#ef4444}
*{box-sizing:border-box;font-family:Inter,Segoe UI,Tahoma,Arial}
body{margin:0;background:linear-gradient(180deg,#f0f4ff,#ffffff);color:#111;padding:18px}
.container{max-width:1200px;margin:0 auto}
.header{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,var(--p),#111827);color:#fff;padding:12px;border-radius:8px}
.grid{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:16px}
.card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 6px 18px rgba(16,24,40,.04)}
.controls button{width:100%;margin-bottom:8px;padding:10px;border-radius:8px;border:none;background:var(--s);color:#fff;cursor:pointer}
.icon-btn{background:transparent;border:1px solid #e6eefc;padding:8px;border-radius:8px;cursor:pointer}
.table-wrap{overflow:auto;max-height:560px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #eef2ff;text-align:right}
th{background:var(--p);color:#fff;position:sticky;top:0}
.preview-plate{font-weight:800;font-size:20px;letter-spacing:2px;background:#0f172a;color:#fff;padding:8px;border-radius:6px;display:inline-block}
.camera-area{background:#000;border-radius:8px;height:300px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
.hidden{display:none}
.badge{display:inline-block;padding:6px 10px;border-radius:8px;background:#e6eefc;color:#0f172a;font-weight:700}
.modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,.45);align-items:center;justify-content:center;z-index:60}
.dialog{width:94%;max-width:860px;background:#fff;padding:16px;border-radius:10px}
.small{display:flex;gap:8px}
.note{max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.blacklist{color:#fff;background:var(--a);padding:6px 8px;border-radius:6px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div><strong>نظام تتبع حضيرة السيارات</strong></div>
    <div style="display:flex;gap:10px;align-items:center">
      <span class="badge" id="totalCars">0</span>
      <button class="icon-btn" id="exportBtn"><i class="fas fa-file-export"></i></button>
      <button class="icon-btn" id="importBtn"><i class="fas fa-file-import"></i></button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h4>أدوات</h4>
      <div style="margin:8px 0"><input id="searchInput" placeholder="ابحث..." style="width:100%;padding:8px;border-radius:6px;border:1px solid #eef2ff"></div>
      <div class="small" style="margin-bottom:8px">
        <button onclick="searchData()" style="flex:1">بحث</button>
        <button onclick="clearSearch()" style="flex:1;background:#6b7280">مسح</button>
      </div>

      <button onclick="openAddModal()">إضافة سيارة</button>
      <button onclick="openScannerModal()">مسح لوحة (كاميرا تلقائي)</button>

      <div style="margin-top:10px">
        <input id="fileIn" type="file" accept=".xlsx,.xls" class="hidden">
        <button onclick="document.getElementById('fileIn').click()">استيراد Excel</button>
        <button onclick="exportToExcel()">تصدير Excel</button>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef2ff"/>

      <h4>قائمة سوداء</h4>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="blackPlate" placeholder="أدخل رقم اللوحة" style="flex:1;padding:8px;border-radius:6px;border:1px solid #eef2ff" />
        <button onclick="addToBlacklist()">أضف</button>
      </div>
      <div id="blacklistContainer"></div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef2ff"/>
      <div>ملاحظة: المعالجة التلقائية تعمل بمعايير ثابتة مخفية لتحسين الدقة عبر OpenCV ثم Tesseract.</div>
    </div>

    <div class="card">
      <h4>قاعدة بيانات السيارات</h4>
      <div class="table-wrap">
        <table id="carsTable"><thead>
          <tr>
            <th onclick="sortTable('driverName')">السائق</th>
            <th onclick="sortTable('position')">الوحدة</th>
            <th onclick="sortTable('brand')">العلامة</th>
            <th onclick="sortTable('carName')">النوع</th>
            <th onclick="sortTable('registrationNumber')">رقم التسجيل</th>
            <th>هاتف</th>
            <th>ملاحظة</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody></table>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="addModal" class="modal"><div class="dialog">
  <h3 id="addTitle">إضافة / تعديل</h3>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <input id="m_driverName" placeholder="اسم السائق"/><input id="m_position" placeholder="الوحدة"/>
    <input id="m_brand" placeholder="العلامة"/><input id="m_carName" placeholder="نوع المركبة"/>
    <input id="m_registrationNumber" placeholder="رقم التسجيل"/><input id="m_phoneNumber" placeholder="هاتف"/>
    <textarea id="m_note" placeholder="ملاحظة" style="grid-column:1/3"></textarea>
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
    <button onclick="saveModal()">حفظ</button><button onclick="closeModal('addModal')">إلغاء</button>
  </div>
</div></div>

<div id="scannerModal" class="modal"><div class="dialog">
  <h3>مسح لوحة الترقيم — تلقائي</h3>
  <div style="display:flex;gap:12px;align-items:flex-start">
    <div style="flex:1">
      <div class="camera-area" id="cameraArea">
        <video id="video" playsinline autoplay class="hidden" style="width:100%;height:100%;object-fit:cover"></video>
        <canvas id="canvasPreview" class="hidden" style="width:100%;height:100%"></canvas>
        <div id="cameraPlaceholder" style="color:#fff">الكاميرا غير مفعلة</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button onclick="enableCamera()">تفعيل الكاميرا</button>
        <button onclick="stopCamera()">إيقاف الكاميرا</button>
        <input id="uploadImg" type="file" accept="image/*" style="margin-left:6px"/>
      </div>
    </div>

    <div style="width:340px">
      <div>لوحة المعاينة</div>
      <div style="margin:8px 0"><span class="preview-plate" id="platePreview">--- ---</span></div>
      <div id="matchResult"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button onclick="runOcrOnCurrent()">تحليل يدوي للصورة الحالية</button>
        <button onclick="closeModal('scannerModal')">إغلاق</button>
      </div>
    </div>
  </div>
</div></div>

<!-- Hidden file input for excel -->
<input id="fileInHidden" type="file" accept=".xlsx,.xls" class="hidden">

<script>
/* ================= مقادير مخفية ومعايير ثابتة محسنة ================= */
const OPENCV_PARAMS = {
  cannyLow: 50,
  cannyHigh: 150,
  morphKernel: {w:17,h:3},
  minRatio: 2.0,
  maxRatio: 8.0,
  minWidth: 60,
  claheClip: 2.0,
  claheTile: 8,
  sampleIntervalMs: 1200, // فاصل المسح التلقائي عند الكاميرا
  minArea: 3000
};

/* ================= متغيرات عامة ================= */
let carsData = [];
let blacklist = [];
const LS_KEY = 'fleet_auto_opencv_v1';
const LS_BLACK = 'fleet_black_v1';
let editIndex = -1;
let sortCol = null, sortDir = 'asc';
let videoStream = null;
let opencvReady = false;
let tesseractWorker = null;
let autoScanTimer = null;
let lastRecognized = '';
let scanningEnabled = false;

/* ===== انتظار OpenCV جاهز ===== */
function onOpenCvReady(){ opencvReady = true; console.log('OpenCV ready'); }
if (typeof cv !== 'undefined') {
  if (cv['onRuntimeInitialized']) cv['onRuntimeInitialized']=onOpenCvReady;
  else onOpenCvReady();
}

/* ===== إعداد Tesseract لمرة واحدة ===== */
(async function initTesseract(){
  tesseractWorker = Tesseract.createWorker({ logger: m => {} });
  await tesseractWorker.load();
  await tesseractWorker.loadLanguage('ara+eng');
  await tesseractWorker.initialize('ara+eng');
})();

/* ===== تحميل من LocalStorage ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  const s = localStorage.getItem(LS_KEY);
  const b = localStorage.getItem(LS_BLACK);
  if (s) carsData = JSON.parse(s);
  if (b) blacklist = JSON.parse(b);
  renderTable(); renderBlacklist(); updateStats();
});

/* ===== CRUD و UI بسيطة ===== */
function openAddModal(idx=-1){
  editIndex = idx;
  document.getElementById('addModal').style.display = 'flex';
  if (idx===-1){
    ['m_driverName','m_position','m_brand','m_carName','m_registrationNumber','m_phoneNumber','m_note'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('addTitle').textContent = 'إضافة سيارة';
  } else {
    const c = carsData[idx];
    document.getElementById('addTitle').textContent = 'تعديل سيارة';
    document.getElementById('m_driverName').value = c.driverName||'';
    document.getElementById('m_position').value = c.position||'';
    document.getElementById('m_brand').value = c.brand||'';
    document.getElementById('m_carName').value = c.carName||'';
    document.getElementById('m_registrationNumber').value = c.registrationNumber||'';
    document.getElementById('m_phoneNumber').value = c.phoneNumber||'';
    document.getElementById('m_note').value = c.note||'';
  }
}
function closeModal(id){ document.getElementById(id).style.display='none'; }
function saveModal(){
  const obj = {
    driverName: document.getElementById('m_driverName').value.trim(),
    position: document.getElementById('m_position').value.trim(),
    brand: document.getElementById('m_brand').value.trim(),
    carName: document.getElementById('m_carName').value.trim(),
    registrationNumber: document.getElementById('m_registrationNumber').value.trim(),
    phoneNumber: document.getElementById('m_phoneNumber').value.trim(),
    note: document.getElementById('m_note').value.trim()
  };
  if (!obj.registrationNumber){ alert('أدخل رقم التسجيل'); return; }
  if (editIndex===-1) carsData.push(obj); else carsData[editIndex] = obj;
  persist(); closeModal('addModal'); renderTable(); updateStats();
}

/* ===== حفظ واستعادة ===== */
function persist(){ localStorage.setItem(LS_KEY, JSON.stringify(carsData)); localStorage.setItem(LS_BLACK, JSON.stringify(blacklist)); }

/* ===== عرض الجدول ===== */
function renderTable(filter=null){
  const tbody = document.getElementById('tbody'); tbody.innerHTML='';
  const data = filter || carsData;
  if (!data.length){ tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:18px">لا توجد بيانات</td></tr>'; return; }
  data.forEach((c,i)=>{
    const isBlack = blacklist.includes((c.registrationNumber||'').replace(/\s+/g,'').toLowerCase());
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${esc(c.driverName)}</td>
      <td>${esc(c.position)}</td>
      <td>${esc(c.brand)}</td>
      <td>${esc(c.carName)}</td>
      <td>${esc(c.registrationNumber)} ${isBlack?'<span class="blacklist">محظورة</span>':''}</td>
      <td>${esc(c.phoneNumber)}</td>
      <td class="note">${esc(c.note)}</td>
      <td style="white-space:nowrap">
        <button onclick="openAddModal(${i})">تعديل</button>
        <button onclick="deleteRow(${i})" style="margin-left:6px;background:var(--a);color:#fff">حذف</button>
      </td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('totalCars').textContent = carsData.length;
}
function esc(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function deleteRow(i){ if (!confirm('تأكيد الحذف؟')) return; carsData.splice(i,1); persist(); renderTable(); updateStats(); }

/* ===== فرز وبحث ===== */
function sortTable(col){
  if (sortCol===col) sortDir = sortDir==='asc'?'desc':'asc'; else { sortCol = col; sortDir='asc'; }
  carsData.sort((a,b)=>{ const A=(a[col]||'').toString().toLowerCase(); const B=(b[col]||'').toString().toLowerCase(); if (A<B) return sortDir==='asc'?-1:1; if (A>B) return sortDir==='asc'?1:-1; return 0; });
  renderTable();
}
function searchData(){ const q = document.getElementById('searchInput').value.trim().toLowerCase(); if (!q) return renderTable(); const filtered = carsData.filter(c=>Object.values(c).some(v=>(v||'').toString().toLowerCase().includes(q))); renderTable(filtered); }
function clearSearch(){ document.getElementById('searchInput').value=''; renderTable(); }

/* ===== قائمة سوداء ===== */
function addToBlacklist(){ const p=document.getElementById('blackPlate').value.trim(); if(!p) return; const key=p.replace(/\s+/g,'').toLowerCase(); if(!blacklist.includes(key)) blacklist.push(key); document.getElementById('blackPlate').value=''; renderBlacklist(); persist(); updateStats(); }
function removeFromBlacklist(i){ blacklist.splice(i,1); renderBlacklist(); persist(); updateStats(); }
function renderBlacklist(){ const c=document.getElementById('blacklistContainer'); c.innerHTML=''; if(!blacklist.length){ c.innerHTML='<div>لا توجد لوحات محظورة</div>'; return; } blacklist.forEach((b,i)=>{ const div=document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='6px'; div.innerHTML=`<div class="blacklist">${b.toUpperCase()}</div><button onclick="removeFromBlacklist(${i})">إزالة</button>`; c.appendChild(div); }); }
function updateStats(){ document.getElementById('totalCars').textContent = carsData.length; }

/* ===== استيراد / تصدير Excel ===== */
document.getElementById('fileIn').addEventListener('change', loadExcelFile);
function loadExcelFile(e){ const f=e.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=(ev)=>{ const wb=XLSX.read(ev.target.result,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; const json=XLSX.utils.sheet_to_json(ws); json.forEach(row=>carsData.push({
  driverName: row['إسم مستخدم المركبة']||row['driverName']||'',
  position: row['الوحدة/المصلحة']||row['position']||'',
  brand: row['العلامة التجارية']||row['brand']||'',
  carName: row['نوع المركبة']||row['carName']||'',
  registrationNumber: row['رقم تسجيل المركبة']||row['registrationNumber']||'',
  phoneNumber: row['هاتف المستخدم']||row['phoneNumber']||'',
  note: row['الملاحظة']||row['note']||''
})); persist(); renderTable(); updateStats(); }; reader.readAsArrayBuffer(f); e.target.value=''; }
function exportToExcel(){ if(!carsData.length){ alert('لا توجد بيانات للتصدير'); return; } const out=carsData.map(c=>({'إسم مستخدم المركبة':c.driverName,'الوحدة/المصلحة':c.position,'العلامة التجارية':c.brand,'نوع المركبة':c.carName,'رقم تسجيل المركبة':c.registrationNumber,'هاتف المستخدم':c.phoneNumber,'الملاحظة':c.note})); const ws=XLSX.utils.json_to_sheet(out); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'بيانات'); XLSX.writeFile(wb,'بيانات_السيارات.xlsx'); }

/* ===== كاميرا وتحليل تلقائي ===== */
document.getElementById('uploadImg').addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const url=URL.createObjectURL(f); await loadImageToCanvas(url); });

async function enableCamera(){
  try {
    const v=document.getElementById('video');
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}}});
    videoStream=stream; v.srcObject=stream; v.classList.remove('hidden'); document.getElementById('cameraPlaceholder').classList.add('hidden');
    await v.play();
    startAutoScan();
  } catch(err){ alert('تعذر الوصول إلى الكاميرا'); console.error(err); }
}
function stopCamera(){ if (videoStream) videoStream.getTracks().forEach(t=>t.stop()); const v=document.getElementById('video'); v.pause(); v.classList.add('hidden'); document.getElementById('cameraPlaceholder').classList.remove('hidden'); stopAutoScan(); scanningEnabled=false; }

async function captureFrameToCanvas(){
  const v=document.getElementById('video');
  const c=document.getElementById('canvasPreview');
  c.width = v.videoWidth; c.height = v.videoHeight;
  c.getContext('2d').drawImage(v,0,0,c.width,c.height);
  c.classList.remove('hidden');
  return c;
}
async function loadImageToCanvas(src){
  const img=new Image(); img.src=src; await img.decode();
  const c=document.getElementById('canvasPreview');
  c.width=img.naturalWidth; c.height=img.naturalHeight; c.getContext('2d').drawImage(img,0,0,c.width,c.height);
  c.classList.remove('hidden');
  runOcrOnCanvas(c);
}

/* تشغيل المسح التلقائي: يأخذ لقطة كل OPENCV_PARAMS.sampleIntervalMs مللي ثانية */
function startAutoScan(){
  if (autoScanTimer) clearInterval(autoScanTimer);
  scanningEnabled = true;
  autoScanTimer = setInterval(async ()=>{
    try {
      const c = await captureFrameToCanvas();
      // معالجة OpenCV واستخراج ROI (إن وُجد) ثم OCR إن لزم
      const {dataUrl, roiFound} = await preprocessWithOpenCV(c);
      if (!roiFound) return;
      // تجنب تشغيل OCR إن تم التعرف مؤخرا على نفس اللوحة
      const plate = await recognizeDataUrl(dataUrl);
      if (plate && plate !== lastRecognized){
        lastRecognized = plate;
        document.getElementById('platePreview').textContent = plate;
        checkMatch(plate);
      }
    } catch(e){ console.error('autoScan error', e); }
  }, OPENCV_PARAMS.sampleIntervalMs);
}
function stopAutoScan(){ if (autoScanTimer) clearInterval(autoScanTimer); autoScanTimer=null; }

/* ===== معالجة OpenCV تلقائية =====
   ترجع {dataUrl, roiFound:true/false}
*/
function preprocessWithOpenCV(canvas){
  return new Promise((resolve)=>{
    if (!opencvReady){ resolve({dataUrl: canvas.toDataURL(), roiFound:true}); return; }
    try {
      const src = cv.imread(canvas);
      let gray = new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      // فلتر تقليل الضجيج
      let blur = new cv.Mat(); cv.bilateralFilter(gray, blur, 9, 75, 75);
      // CLAHE لتحسين التباين
      let clahe = new cv.Mat();
      let claheObj = new cv.CLAHE(OPENCV_PARAMS.claheClip, new cv.Size(OPENCV_PARAMS.claheTile, OPENCV_PARAMS.claheTile));
      claheObj.apply(blur, clahe);
      // كشف الحواف
      let edges = new cv.Mat(); cv.Canny(clahe, edges, OPENCV_PARAMS.cannyLow, OPENCV_PARAMS.cannyHigh);
      // مورفولوجي لملء الفواصل
      let kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(OPENCV_PARAMS.morphKernel.w, OPENCV_PARAMS.morphKernel.h));
      cv.morphologyEx(edges, edges, cv.MORPH_CLOSE, kernel);
      // إيجاد contours
      let contours = new cv.MatVector(); let hierarchy = new cv.Mat();
      cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
      // بحث عن مستطيل محتمل للوحة
      let maxRect = null; let maxArea = 0;
      for (let i=0;i<contours.size();i++){
        const cnt = contours.get(i);
        const peri = cv.arcLength(cnt, true);
        const approx = new cv.Mat();
        cv.approxPolyDP(cnt, approx, 0.02 * peri, true);
        if (approx.rows >= 4){
          const rect = cv.boundingRect(approx);
          const area = rect.width * rect.height;
          const ratio = rect.width / rect.height;
          if (area > maxArea && area > OPENCV_PARAMS.minArea && ratio > OPENCV_PARAMS.minRatio && ratio < OPENCV_PARAMS.maxRatio && rect.width > OPENCV_PARAMS.minWidth){
            maxArea = area; maxRect = rect;
          }
        }
        cnt.delete(); approx.delete();
      }

      let resultCanvas = document.createElement('canvas'); let roiFound = false;
      if (maxRect){
        roiFound = true;
        resultCanvas.width = maxRect.width; resultCanvas.height = maxRect.height;
        const roi = src.roi(maxRect);
        // معالجة نها