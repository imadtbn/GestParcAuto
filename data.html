<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التعرف الآلي على لوحات السيارات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* إعدادات عامة */
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f5f7fa;
            --dark-bg: #2c3e50;
            --text-light: #ecf0f1;
            --shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--light-bg) 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
            transition: all 0.3s ease;
        }

        /* الوضع الليلي */
        body.dark-mode {
            background: var(--dark-bg);
            color: var(--text-light);
        }

        .dark-mode .anpr-section,
        .dark-mode .result-box,
        .dark-mode .vehicle-management {
            background: #34495e;
            color: var(--text-light);
        }

        /* الهيدر */
        header {
            background: var(--secondary-color);
            color: white;
            text-align: center;
            padding: 20px;
            box-shadow: var(--shadow);
            position: relative;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .btn-mode {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: 2px solid white;
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-mode:hover {
            background: white;
            color: var(--secondary-color);
        }

        /* المحتوى الرئيسي */
        main {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* قسم ANPR */
        .anpr-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .anpr-section h2 {
            color: var(--secondary-color);
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8rem;
        }

        .camera-container {
            position: relative;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #camera-feed {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
        }

        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .btn.success {
            background: var(--success-color);
        }

        .btn.warning {
            background: var(--warning-color);
        }

        .result-box {
            background: #ecf0f1;
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            border-left: 5px solid var(--success-color);
            animation: slideIn 0.5s ease;
            display: none;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-box h3 {
            color: var(--success-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .result-box p {
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        /* قسم إدارة المركبات */
        .vehicle-management {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--shadow);
        }

        .vehicle-management h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        .placeholder {
            text-align: center;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #ddd;
        }

        /* الفوتر */
        footer {
            text-align: center;
            padding: 20px;
            background: var(--secondary-color);
            color: white;
            margin-top: 50px;
        }

        /* تصميم متجاوب */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 80%;
                justify-content: center;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }

        /* تصميم الإشعارات */
        .notification {
            position: fixed;
            top: 20px;
            right: 50%;
            transform: translateX(50%);
            background: white;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transition: all 0.3s ease;
            min-width: 300px;
            justify-content: center;
        }

        .notification.success {
            border-left: 5px solid #27ae60;
            color: #27ae60;
        }

        .notification.error {
            border-left: 5px solid #e74c3c;
            color: #e74c3c;
        }

        .notification.warning {
            border-left: 5px solid #f39c12;
            color: #f39c12;
        }

        .notification.info {
            border-left: 5px solid #3498db;
            color: #3498db;
        }

        .notification i {
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <header>
        <button class="btn-mode" id="dark-mode-toggle">
            <i class="fas fa-moon"></i>
        </button>
        <h1>نظام التعرف الآلي على لوحات السيارات</h1>
        <p>نظام متكامل لإدارة دخول وخروج المركبات</p>
    </header>

    <main>
        <section class="anpr-section">
            <h2>التعرف على لوحة السيارة</h2>
            
            <div class="camera-container">
                <video id="camera-feed" autoplay playsinline></video>
                <canvas id="capture-canvas" style="display: none;"></canvas>
                
                <div class="loading" id="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>جاري معالجة الصورة...</p>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" id="start-camera">
                    <i class="fas fa-camera"></i> تشغيل الكاميرا
                </button>
                <button class="btn success" id="capture-btn" disabled>
                    <i class="fas fa-camera-retro"></i> التقاط صورة
                </button>
                <button class="btn warning" id="stop-camera" disabled>
                    <i class="fas fa-stop"></i> إيقاف الكاميرا
                </button>
            </div>
            
            <div class="result-box" id="anpr-result">
                <h3>تم التعرف على اللوحة</h3>
                <p><strong>رقم اللوحة:</strong> <span id="plate-number">---</span></p>
                <p><strong>مستوى الدقة:</strong> <span id="confidence">---</span>%</p>
                <p><strong>وقت المسح:</strong> <span id="timestamp">---</span></p>
                
                <div class="action-buttons">
                    <button class="btn success" id="confirm-entry">
                        <i class="fas fa-check"></i> تأكيد الدخول
                    </button>
                    <button class="btn warning" id="retry-capture">
                        <i class="fas fa-redo"></i> إعادة المحاولة
                    </button>
                </div>
            </div>
        </section>
        
        <section class="vehicle-management">
            <h2>إدارة المركبات</h2>
            <div class="placeholder">
                <i class="fas fa-car" style="font-size: 3rem; color: #bdc3c7; margin-bottom: 15px;"></i>
                <p>سيتم عرض سجل المركبات المسجلة هنا</p>
            </div>
        </section>
    </main>
    
    <footer>
        <p>© 2023 نظام التعرف الآلي على لوحات السيارات. جميع الحقوق محفوظة.</p>
    </footer>

    <script>
        // إعدادات النظام
        const CONFIG = {
            ANPR_API: 'https://api.openalpr.com/v2/recognize',
            API_KEY: 'c257fcff27e8e875fb1e68e3694d5195a2c6b730', // استبدل هذا بمفتاحك من OpenALPR
            COUNTRY: 'dz', // للسعودية (غيرها حسب دولتك)
            CONFIDENCE_THRESHOLD: 50 // الحد الأدنى لدقة التعرف
        };

        // متغيرات عامة
        let stream = null;
        let isProcessing = false;

        // عناصر DOM
        const elements = {
            startBtn: document.getElementById('start-camera'),
            captureBtn: document.getElementById('capture-btn'),
            stopBtn: document.getElementById('stop-camera'),
            confirmBtn: document.getElementById('confirm-entry'),
            retryBtn: document.getElementById('retry-capture'),
            darkModeBtn: document.getElementById('dark-mode-toggle'),
            video: document.getElementById('camera-feed'),
            canvas: document.getElementById('capture-canvas'),
            loading: document.getElementById('loading'),
            resultBox: document.getElementById('anpr-result'),
            plateNumber: document.getElementById('plate-number'),
            confidence: document.getElementById('confidence'),
            timestamp: document.getElementById('timestamp')
        };

        // أحداث التهيئة
        document.addEventListener('DOMContentLoaded', () => {
            elements.startBtn.addEventListener('click', startCamera);
            elements.captureBtn.addEventListener('click', captureImage);
            elements.stopBtn.addEventListener('click', stopCamera);
            elements.confirmBtn.addEventListener('click', confirmEntry);
            elements.retryBtn.addEventListener('click', () => {
                elements.resultBox.style.display = 'none';
            });
            elements.darkModeBtn.addEventListener('click', toggleDarkMode);
        });

        // تشغيل الكاميرا
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    } 
                });
                
                elements.video.srcObject = stream;
                elements.startBtn.disabled = true;
                elements.captureBtn.disabled = false;
                elements.stopBtn.disabled = false;
                elements.resultBox.style.display = 'none';
                
                showNotification('تم تشغيل الكاميرا بنجاح', 'success');
            } catch (err) {
                console.error("خطأ في تشغيل الكاميرا:", err);
                showNotification('لا يمكن الوصول للكاميرا. تأكد من منح الإذن', 'error');
            }
        }

        // إيقاف الكاميرا
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                elements.video.srcObject = null;
                elements.startBtn.disabled = false;
                elements.captureBtn.disabled = true;
                elements.stopBtn.disabled = true;
                showNotification('تم إيقاف الكاميرا', 'info');
            }
        }

        // التقاط الصورة
        function captureImage() {
            if (isProcessing) return;
            
            const context = elements.canvas.getContext('2d');
            elements.canvas.width = elements.video.videoWidth;
            elements.canvas.height = elements.video.videoHeight;
            context.drawImage(elements.video, 0, 0);
            
            const imageData = elements.canvas.toDataURL('image/jpeg', 0.8);
            processWithANPR(imageData);
        }

        // معالجة الصورة مع ANPR
        async function processWithANPR(imageData) {
            if (isProcessing) return;
            
            isProcessing = true;
            elements.loading.style.display = 'flex';
            elements.captureBtn.disabled = true;
            
            try {
                // محاكاة للاستجابة من API (للتجربة بدون مفتاح API)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // محاكاة لنتيجة التعرف
                const mockResult = {
                    plate: generateMockPlate(),
                    confidence: Math.floor(Math.random() * 30) + 70
                };
                
                displayANPRResult(mockResult);
                
            } catch (error) {
                console.error('خطأ في معالجة ANPR:', error);
                showNotification('فشل التعرف على اللوحة. حاول مرة أخرى', 'error');
            } finally {
                elements.loading.style.display = 'none';
                elements.captureBtn.disabled = false;
                isProcessing = false;
            }
        }

        // توليد لوحة مركبة عشوائية (للتجربة)
        function generateMockPlate() {
            const letters = 'أبتثجحخدذرزسشصضطظعغفقكلمنهوي';
            const numbers = '0123456789';
            
            let plate = '';
            // توليد حرفين
            for (let i = 0; i < 2; i++) {
                plate += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            
            // توليد 4 أرقام
            for (let i = 0; i < 4; i++) {
                plate += numbers.charAt(Math.floor(Math.random() * numbers.length));
            }
            
            return plate;
        }

        // عرض نتائج ANPR
        function displayANPRResult(result) {
            const confidence = Math.round(result.confidence);
            
            if (confidence >= CONFIG.CONFIDENCE_THRESHOLD) {
                elements.plateNumber.textContent = result.plate;
                elements.confidence.textContent = confidence;
                elements.timestamp.textContent = new Date().toLocaleString('ar-SA');
                elements.resultBox.style.display = 'block';
                
                // تغيير لون الدقة حسب النسبة
                if (confidence >= 90) {
                    elements.confidence.style.color = 'var(--success-color)';
                } else if (confidence >= 80) {
                    elements.confidence.style.color = 'var(--warning-color)';
                } else {
                    elements.confidence.style.color = 'var(--danger-color)';
                }
                
                showNotification('تم التعرف على اللوحة بنجاح', 'success');
            } else {
                showNotification(`دقة التعرف منخفضة (${confidence}%)`, 'warning');
            }
        }

        // تأكيد دخول المركبة
        async function confirmEntry() {
            const plateNumber = elements.plateNumber.textContent;
            const entryTime = new Date().toISOString();
            
            try {
                // محاكاة لحفظ البيانات
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                showNotification(`تم تسجيل دخول السيارة ${plateNumber} بنجاح!`, 'success');
                elements.resultBox.style.display = 'none';
                
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
                showNotification('فشل حفظ البيانات. حاول مرة أخرى', 'error');
            }
        }

        // تبديل الوضع الليلي
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            elements.darkModeBtn.innerHTML = isDark ? 
                '<i class="fas fa-sun"></i>' : 
                '<i class="fas fa-moon"></i>';
            localStorage.setItem('darkMode', isDark);
        }

        // عرض الإشعارات
        function showNotification(message, type = 'info') {
            // إنشاء عنصر الإشعار
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${getNotificationIcon(type)}"></i>
                <span>${message}</span>
            `;
            
            // إضافة الإشعار للصفحة
            document.body.appendChild(notification);
            
            // إزالة الإشعار بعد 3 ثواني
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // الحصول على أيقونة الإشعار
        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }

        // استعادة الوضع الليلي عند تحميل الصفحة
        window.addEventListener('load', () => {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                elements.darkModeBtn.innerHTML = '<i class="fas fa-sun"></i>';
            }
        });

        // معالجة الأخطاء العامة
        window.addEventListener('error', (event) => {
            console.error('خطأ غير متوقع:', event.error);
            showNotification('حدث خطأ غير متوقع. حاول تحديث الصفحة', 'error');
        });
    </script>
</body>
</html>
