<!doctype html>

<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام التعرف الآلي على لوحات السيارات — محسن</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{--primary:#3498db;--secondary:#2c3e50;--success:#27ae60;--danger:#e74c3c;--muted:#95a5a6}
    *{box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,Arial;background:#f5f7fa;color:#222;margin:0;padding:0}
    header{background:var(--secondary);color:#fff;padding:18px;text-align:center;position:relative}
    header h1{margin:0;font-size:1.3rem}
    main{max-width:1200px;margin:22px auto;padding:18px}
    .card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:18px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
    .btn{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    .btn.warn{background:#f39c12}
    .btn.danger{background:var(--danger)}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary)}
    .camera{position:relative;border-radius:8px;overflow:hidden;background:#000;min-height:260px;display:flex;align-items:center;justify-content:center}
    video, img{width:100%;height:auto;display:block}
    #capture-canvas{display:none}
    .result{display:none;padding:12px;margin-top:12px;border-left:4px solid var(--success);background:#f0f7f3}
    form.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    label{display:block;font-size:0.9rem;margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:right}
    th{cursor:pointer;background:#fafafa}
    .small{font-size:0.85rem;color:var(--muted)}
    .badge{padding:4px 8px;border-radius:6px;font-size:0.8rem}
    .blacklisted{background:#e74c3c;color:#fff}
    .actions button{margin-left:6px}
    .notice{padding:8px;border-radius:6px;background:#fff7e6;border:1px solid #f1c27d;color:#7a4b00}
    @media(max-width:700px){form.grid{grid-template-columns:1fr}header h1{font-size:1rem}}
  </style>
</head>
<body>
  <header>
    <h1>نظام التعرف الآلي على لوحات السيارات — نسخة محسنة</h1>
  </header>  <main>
    <section class="card">
      <h2>التقاط ومعالجة اللوحة</h2>
      <div class="camera" id="camera-wrap">
        <video id="video" playsinline autoplay></video>
        <div id="camera-placeholder" style="color:#bbb;text-align:center;padding:14px;">اضغط تشغيل الكاميرا أو ارفع صورة</div>
        <canvas id="capture-canvas"></canvas>
      </div><div class="controls">
    <button class="btn" id="start-camera"><i class="fa fa-camera"></i> تشغيل الكاميرا</button>
    <button class="btn" id="stop-camera" disabled><i class="fa fa-stop"></i> إيقاف</button>
    <button class="btn" id="capture" disabled><i class="fa fa-camera-retro"></i> التقاط</button>
    <label class="btn ghost" style="display:inline-block"><i class="fa fa-upload"></i> رفع صورة<input type="file" id="image-file" accept="image/*" style="display:none"></label>
    <button class="btn warn" id="process-local"><i class="fa fa-magic"></i> تحسين وOCR محلي</button>
  </div>

  <div class="result" id="result-box">
    <p><strong>رقم اللوحة:</strong> <span id="plate">---</span></p>
    <p><strong>دقة ANPR:</strong> <span id="score">--</span></p>
    <p class="small"><strong>الوقت:</strong> <span id="time">--</span></p>
    <div class="controls" style="justify-content:flex-start;margin-top:8px">
      <button class="btn" id="save-entry"><i class="fa fa-save"></i> حفظ السجل</button>
      <button class="btn ghost" id="add-blacklist"><i class="fa fa-ban"></i> إضافة للقائمة السوداء</button>
    </div>
  </div>

  <div class="notice" id="api-note" style="margin-top:10px">تم دمج OpenALPR API. تأكد من مفتاح API في الإعدادات.</div>
</section>

<section class="card">
  <h2>إعدادات السجل</h2>
  <form id="record-form" class="grid" autocomplete="off">
    <div>
      <label>رقم اللوحة</label>
      <input id="f_plate" placeholder="مثال: 123ABC" />
    </div>
    <div>
      <label>المالك</label>
      <input id="f_owner" />
    </div>
    <div>
      <label>مكان العمل / الوحدة</label>
      <input id="f_workplace" />
    </div>
    <div>
      <label>نوع السيارة</label>
      <input id="f_type" />
    </div>
    <div>
      <label>العلامة</label>
      <input id="f_brand" />
    </div>
    <div>
      <label>الهاتف</label>
      <input id="f_phone" />
    </div>
    <div style="grid-column:1/3">
      <label>ملاحظة</label>
      <textarea id="f_note"></textarea>
    </div>
  </form>
  <div class="controls" style="justify-content:flex-end">
    <button class="btn" id="clear-form">حذف الافتراضي</button>
    <button class="btn" id="save-manual"><i class="fa fa-plus"></i> إضافة / حفظ</button>
  </div>
</section>

<section class="card">
  <h2>سجل المركبات</h2>
  <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
    <input id="search" placeholder="بحث" style="padding:8px;border-radius:6px;border:1px solid #ddd">
    <button class="btn ghost" id="export-xlsx"><i class="fa fa-file-export"></i> تصدير Excel</button>
    <label class="btn ghost"><i class="fa fa-file-import"></i> استيراد Excel<input type="file" id="import-xlsx" accept=".xlsx,.xls" style="display:none"></label>
    <button class="btn danger" id="show-blacklist"><i class="fa fa-list"></i> عرض القائمة السوداء</button>
  </div>

  <table id="records-table">
    <thead>
      <tr>
        <th data-key="plate">اللوحة</th>
        <th data-key="owner">المالك</th>
        <th data-key="workplace">مكان العمل</th>
        <th data-key="type">النوع</th>
        <th data-key="brand">العلامة</th>
        <th data-key="phone">الهاتف</th>
        <th data-key="note">ملاحظة</th>
        <th data-key="date">التاريخ</th>
        <th>حالة</th>
        <th>إجراءات</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section class="card small">
  <p>مصادر مكتبات: OpenALPR API, Tesseract.js, OpenCV.js, SheetJS.</p>
</section>

  </main>  <!-- المكتبات -->  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>  <script async src="https://docs.opencv.org/4.x/opencv.js" ></script>  <script>
  // CONFIG
  const CONFIG = {
    ANPR_API: 'https://api.openalpr.com/v2/recognize',
    API_KEY: 'c257fcff27e8e875fb1e68e3694d5195a2c6b730',
    COUNTRY: 'dz',
    CONF_THRESHOLD: 50
  };

  // DOM
  const video = document.getElementById('video');
  const startCameraBtn = document.getElementById('start-camera');
  const stopCameraBtn = document.getElementById('stop-camera');
  const captureBtn = document.getElementById('capture');
  const imageFile = document.getElementById('image-file');
  const processLocalBtn = document.getElementById('process-local');
  const resultBox = document.getElementById('result-box');
  const plateEl = document.getElementById('plate');
  const scoreEl = document.getElementById('score');
  const timeEl = document.getElementById('time');
  const saveEntryBtn = document.getElementById('save-entry');
  const addBlacklistBtn = document.getElementById('add-blacklist');

  const form = {
    plate: document.getElementById('f_plate'),
    owner: document.getElementById('f_owner'),
    workplace: document.getElementById('f_workplace'),
    type: document.getElementById('f_type'),
    brand: document.getElementById('f_brand'),
    phone: document.getElementById('f_phone'),
    note: document.getElementById('f_note')
  };

  const saveManualBtn = document.getElementById('save-manual');
  const clearFormBtn = document.getElementById('clear-form');
  const recordsTable = document.getElementById('records-table').querySelector('tbody');
  const exportXlsxBtn = document.getElementById('export-xlsx');
  const importXlsxInput = document.getElementById('import-xlsx');
  const searchInput = document.getElementById('search');
  const showBlacklistBtn = document.getElementById('show-blacklist');

  let stream=null; let db=null; let currentImageBlob=null; let lastDetected=null; let sortState={key:'date',dir:'desc'};

  // ---------- IndexedDB minimal wrapper ----------
  function openDB(){
    return new Promise((res,rej)=>{
      const rq = indexedDB.open('anpr_db',1);
      rq.onupgradeneeded = e => {
        const idb = e.target.result;
        const store = idb.createObjectStore('records',{keyPath:'id',autoIncrement:true});
        store.createIndex('plate','plate',{unique:false});
        store.createIndex('blacklist','blacklist',{unique:false});
      };
      rq.onsuccess = e => { db = e.target.result; res(db); };
      rq.onerror = e => rej(e);
    });
  }
  async function addRecord(obj){
    const tx = db.transaction('records','readwrite');
    const store = tx.objectStore('records');
    obj.date = new Date().toISOString();
    return new Promise((res,rej)=>{
      const rq = store.add(obj);
      rq.onsuccess = ()=>{ res(true); }; rq.onerror = e=>rej(e);
    });
  }
  function getAllRecords(){
    return new Promise((res,rej)=>{
      const tx = db.transaction('records','readonly');
      const store = tx.objectStore('records');
      const rq = store.getAll();
      rq.onsuccess = ()=>res(rq.result);
      rq.onerror = e=>rej(e);
    });
  }
  function updateRecord(id,changes){
    return new Promise((res,rej)=>{
      const tx = db.transaction('records','readwrite');
      const store = tx.objectStore('records');
      const getRq = store.get(id);
      getRq.onsuccess = ()=>{
        const rec = getRq.result; if(!rec){ rej('not found'); return; }
        Object.assign(rec,changes);
        const putRq = store.put(rec);
        putRq.onsuccess = ()=>res(true); putRq.onerror=e=>rej(e);
      };
      getRq.onerror=e=>rej(e);
    });
  }
  function deleteRecord(id){
    return new Promise((res,rej)=>{
      const tx = db.transaction('records','readwrite');
      const store = tx.objectStore('records');
      const rq = store.delete(id);
      rq.onsuccess = ()=>res(true); rq.onerror=e=>rej(e);
    });
  }

  // ---------- Camera control ----------
  startCameraBtn.addEventListener('click',async()=>{
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280}}});
      video.srcObject = stream; document.getElementById('camera-placeholder').style.display='none';
      stopCameraBtn.disabled=false; captureBtn.disabled=false; startCameraBtn.disabled=true;
    }catch(e){alert('فشل الوصول للكاميرا');}
  });
  stopCameraBtn.addEventListener('click',()=>{ if(stream){stream.getTracks().forEach(t=>t.stop());video.srcObject=null;startCameraBtn.disabled=false;stopCameraBtn.disabled=true;captureBtn.disabled=true;document.getElementById('camera-placeholder').style.display='block';}});
  captureBtn.addEventListener('click',async()=>{ const canvas=document.getElementById('capture-canvas'); canvas.width=video.videoWidth; canvas.height=video.videoHeight; canvas.getContext('2d').drawImage(video,0,0); canvas.toBlob(b=>{ currentImageBlob=b; processImageBlob(b); },'image/jpeg',0.9); });

  // ملف مرفوع
  imageFile.addEventListener('change',e=>{ const f=e.target.files[0]; if(!f) return; currentImageBlob=f; processImageBlob(f); });

  // ---------- Image preprocessing + local OCR (Tesseract) ----------
  async function processImageBlob(blob){
    showResult('جاري الإرسال للمعالجة...','--');
    // ارسال الى OpenALPR
    try{
      const anpr = await callOpenAlpr(blob);
      if(anpr && anpr.results && anpr.results.length){
        const top = anpr.results[0];
        const plate = top.plate || top.best_plate || '';
        const score = Math.round((top.confidence||top.confidence_score||0));
        showResult(plate,score,anpr);
        lastDetected = {plate,score,raw:anpr};
        // املأ النموذج تلقائياً
        form.plate.value = plate; form.note.value = '';
      }else{
        // fallback local OCR
        const text = await localOCR(blob);
        showResult(text,0);
        lastDetected = {plate:text,score:0,raw:null};
        form.plate.value = text;
      }
    }catch(e){
      console.error(e);
      const text = await localOCR(blob);
      showResult(text,0);
      lastDetected = {plate:text,score:0,raw:null};
      form.plate.value = text;
    }
  }

  function showResult(plate,score,raw){
    plateEl.textContent = plate || '---'; scoreEl.textContent = score || '--'; timeEl.textContent = new Date().toLocaleString(); resultBox.style.display='block';
  }

  async function localOCR(blob){
    try{
      const { createWorker } = Tesseract;
      const worker = createWorker({logger:m=>console.log(m)});
      await worker.load(); await worker.loadLanguage('eng'); await worker.initialize('eng');
      const { data:{text} } = await worker.recognize(blob);
      await worker.terminate();
      return (text||'').replace(/\s+/g,'').toUpperCase();
    }catch(e){return ''}
  }

  // ---------- OpenALPR API call ----------
  async function callOpenAlpr(blob){
    const url = `${CONFIG.ANPR_API}?secret_key=${CONFIG.API_KEY}&recognize_vehicle=0&country=${CONFIG.COUNTRY}&return_image=0`;
    const fd = new FormData(); fd.append('image',blob);
    const resp = await fetch(url,{method:'POST',body:fd});
    if(!resp.ok) throw new Error('ANPR API failed');
    return resp.json();
  }

  // ---------- Save / Blacklist ----------
  saveEntryBtn.addEventListener('click',async()=>{ if(!form.plate.value){alert('لا يوجد رقم لوحة');return;} const obj = buildRecordFromForm(); await addRecord(obj); await refreshTable(); alert('تم الحفظ'); clearForm(); });
  addBlacklistBtn.addEventListener('click',async()=>{ if(!form.plate.value){alert('لا يوجد لوحة');return;} const obj = buildRecordFromForm(); obj.blacklist = true; await addRecord(obj); await refreshTable(); alert('أضيف للقائمة السوداء'); clearForm(); });

  saveManualBtn.addEventListener('click',async()=>{ if(!form.plate.value){alert('أدخل رقم اللوحة');return;} const obj = buildRecordFromForm(); await addRecord(obj); await refreshTable(); clearForm(); });
  clearFormBtn.addEventListener('click',()=>{ clearForm(); });

  function buildRecordFromForm(){ return {
    plate: form.plate.value.trim(), owner: form.owner.value.trim(), workplace: form.workplace.value.trim(), type: form.type.value.trim(), brand: form.brand.value.trim(), phone: form.phone.value.trim(), note: form.note.value.trim(), image: null, blacklist: false
  }; }
  function clearForm(){ form.plate.value=''; form.owner.value=''; form.workplace.value=''; form.type.value=''; form.brand.value=''; form.phone.value=''; form.note.value=''; }

  // ---------- Table render, edit, delete, sorting, search ----------
  async function refreshTable(){ const records = await getAllRecords(); renderTable(records); }
  function renderTable(records){
    // filter search
    const q = (searchInput.value||'').trim().toLowerCase(); let arr = records.filter(r=> !q || (r.plate||'').toLowerCase().includes(q) || (r.owner||'').toLowerCase().includes(q));
    // sort
    arr.sort((a,b)=>{
      const k = sortState.key; const dir = sortState.dir==='asc'?1:-1;
      const va = (a[k]||'').toString(); const vb = (b[k]||'').toString(); return va>vb?dir:-dir;
    });
    recordsTable.innerHTML='';
    arr.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td contenteditable data-id="${r.id}" data-field="plate">${escapeHtml(r.plate||'')}</td>
        <td contenteditable data-id="${r.id}" data-field="owner">${escapeHtml(r.owner||'')}</td>
        <td contenteditable data-id="${r.id}" data-field="workplace">${escapeHtml(r.workplace||'')}</td>
        <td contenteditable data-id="${r.id}" data-field="type">${escapeHtml(r.type||'')}</td>
        <td contenteditable data-id="${r.id}" data-field="brand">${escapeHtml(r.brand||'')}</td>
        <td contenteditable data-id="${r.id}" data-field="phone">${escapeHtml(r.phone||'')}</td>
        <td contenteditable data-id="${r.id}" data-field="note">${escapeHtml(r.note||'')}</td>
        <td>${new Date(r.date).toLocaleString()}</td>
        <td>${r.blacklist?'<span class="badge blacklisted">ممنوعة</span>':''}</td>
        <td class="actions">
          <button class="btn" data-action="save" data-id="${r.id}"><i class="fa fa-save"></i></button>
          <button class="btn danger" data-action="delete" data-id="${r.id}"><i class="fa fa-trash"></i></button>
        </td>`;
      recordsTable.appendChild(tr);
    });
  }

  recordsTable.addEventListener('click',async(e)=>{
    const btn = e.target.closest('button'); if(!btn) return; const action=btn.dataset.action; const id = Number(btn.dataset.id);
    if(action==='delete'){ if(!confirm('تأكيد الحذف؟')) return; await deleteRecord(id); await refreshTable(); }
    if(action==='save'){ // save edited row fields
      const row = btn.closest('tr'); const edits = {}; row.querySelectorAll('[contenteditable]').forEach(td=>edits[td.dataset.field]=td.textContent.trim()); await updateRecord(id,edits); await refreshTable(); }
  });

  // inline edits save when losing focus
  recordsTable.addEventListener('focusout',async(e)=>{
    const td = e.target.closest('[contenteditable]'); if(!td) return; const id=Number(td.dataset.id); const field = td.dataset.field; const val = td.textContent.trim(); await updateRecord(id,{[field]:val});
  });

  // sorting
  document.querySelectorAll('#records-table thead th[data-key]').forEach(th=>{
    th.addEventListener('click',()=>{ const key=th.dataset.key; if(sortState.key===key) sortState.dir = sortState.dir==='asc'?'desc':'asc'; else { sortState.key=key; sortState.dir='asc'; } refreshTable(); });
  });

  searchInput.addEventListener('input',()=>refreshTable());

  // ---------- Export / Import Excel (SheetJS) ----------
  exportXlsxBtn.addEventListener('click',async()=>{
    const records = await getAllRecords(); const aoa = [['id','plate','owner','workplace','type','brand','phone','note','date','blacklist']]; records.forEach(r=> aoa.push([r.id,r.plate,r.owner,r.workplace,r.type,r.brand,r.phone,r.note,r.date,r.blacklist])); const ws = XLSX.utils.aoa_to_sheet(aoa); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'records'); XLSX.writeFile(wb,'anpr_records.xlsx');
  });

  importXlsxInput.addEventListener('change',async(e)=>{
    const f = e.target.files[0]; if(!f) return; const data = await f.arrayBuffer(); const wb = XLSX.read(data); const ws = wb.Sheets[wb.SheetNames[0]]; const arr = XLSX.utils.sheet_to_json(ws,{header:1}); arr.shift(); // header
    for(const row of arr){ const obj = { plate:row[1]||'', owner:row[2]||'', workplace:row[3]||'', type:row[4]||'', brand:row[5]||'', phone:row[6]||'', note:row[7]||'', date: row[8]||new Date().toISOString(), blacklist: !!row[9] }; await addRecord(obj); }
    await refreshTable(); alert('تم الاستيراد');
  });

  // ---------- Helpers ----------
  function escapeHtml(s){ return String(s).replace(/[&<>\"]+/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c)); }

  // ---------- Init ----------
  (async()=>{ await openDB(); await refreshTable(); })();

  // ---------- Blacklist view ----------
  showBlacklistBtn.addEventListener('click',async()=>{ const all = await getAllRecords(); const bl = all.filter(r=>r.blacklist); if(!bl.length){ alert('لا توجد مركبات في القائمة السوداء'); return; } renderTable(bl); });

  // ---------- drag & drop improvements: not required now ----------

  </script></body>
</html>